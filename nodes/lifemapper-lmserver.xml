<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Lifemapper-server roll.
	LMserver installation 
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org
	</copyright>

	<changelog>
	</changelog>

        <package>libxslt</package>
        <package>opt-MySQL-python</package>
        <package>opt-rtree</package>
        <package>lifemapper-spatialindex</package>
        <package>lifemapper-server-data</package>
        <package>strace</package>

        <!-- postgres and dependencies -->
        <package>postgresql91</package>
        <package>postgresql91-libs</package>
        <package>postgresql91-devel</package>
        <package>postgresql91-server</package>
        <package>postgresql91-docs</package>
        <package>mx</package>
        <package>postgresql91-python</package>
        <package>uuid</package>
        <package>postgresql91-contrib</package>
        <package>postgresql91-test</package>

        <!-- pgbouncer and dependencies -->
        <package>lifemapper-libevent</package>
        <package>pgbouncer</package>

        <!-- postgis and dependencies -->
        <package>json-c</package>
        <package>geos</package>
        <package>proj</package>
        <package>postgis2_91</package>
<post>

/usr/sbin/usermod -G postgres pgbouncer
export PATH=/usr/pgsql-9.1/bin:$PATH

# set mode to strict (2) to prevent postgres being killed  by OOM 
/sbin/sysctl -w vm.overcommit_memory=2

<file name="/etc/sysctl.conf" mode="append">

# Postgres (for lifemapper)
# Set overcommit_memory mode to strict to reduce chances of OOM killer invocation
vm.overcommit_memory = 2
</file>

# create unix socket dir for postgres and pgbouncer
mkdir -p /var/run/postgresql
chown postgres:postgres /var/run/postgresql
chmod 0770 /var/run/postgresql

PG=`basename /etc/init.d/postgresql-*`
/sbin/chkconfig --add $PG 
/sbin/chkconfig $PG on

/sbin/chkconfig --add pgbouncer 
/sbin/chkconfig pgbouncer on

<file name="/etc/rc.d/rocksconfig.d/post-99-lifemapper-lmserver" perms="0700">
#!/bin/bash
# do db initialization and start services

/opt/lifemapper/rocks/bin/firstBootStart
rm -rf /etc/rc.d/rocksconfig.d/post-99-lifemapper-lmserver

</file>

# may need this later for postgres tuning 
# rocks set network mtu public 9000
# rocks sync host network `hostname -s`
</post>

</kickstart>
