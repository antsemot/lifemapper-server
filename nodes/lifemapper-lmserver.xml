<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Lifemapper-server roll.
	LMserver installation 
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org
	</copyright>

	<changelog>
	</changelog>

        <package>libxslt</package>
        <package>opt-MySQL-python</package>
        <package>opt-rtree</package>
        <package>lifemapper-spatialindex</package>
        <package>lifemapper-server-data</package>
        <package>strace</package>

<post>

# install postgres
yum --enablerepo base update openssl
yum --enablerepo pdgd91 install postgresql91
yum --enablerepo pdgd91 install postgresql91-devel
yum --enablerepo pdgd91 install postgresql91-server
yum --enablerepo pdgd91 install postgresql91-docs
yum --enablerepo pdgd91 install postgresql91-python
yum --enablerepo=base install uuid
yum --enablerepo pdgd91 install postgresql91-contrib
yum --enablerepo pdgd91 install postgresql91-test

# yum install postgresql91-jdbc
# yum --enablerepo base install unixODBC
# yum install postgresql91-odbc
#yum install postgresql91-plpython
#yum install postgresql91-pltcl
#yum install postgresql91-libs

# install pgbouncer
yum --enablerepo pdgd91 install pgbouncer
usermod -G postgres pgbouncer

# install postgis
export PATH=/usr/pgsql-9.1/bin:$PATH
yum --enablerepo epel install json-c.x86_64

# this installs proj and geos rpms
yum --enablerepo pdgd91 install postgis2_91

# set mode to strict (2) to prevent postgres being killed  by OOM 
/sbin/sysctl -w vm.overcommit_memory=2

<file name="/etc/sysctl.conf" mode="append">

# Postgres (for lifemapper)
# Set overcommit_memory mode to strict to reduce chances of OOM killer invocation
vm.overcommit_memory = 2
</file>

# create unix socket dir for postgres and pgbouncer
mkdir -p /var/run/postgresql
chown postgres:postgres /var/run/postgresql
chmod 0770 /var/run/postgresql

# add unix socket info for postgres user
<file name="/var/lib/pgsql/.bash_profile" mode="append">
PGHOST=/var/run/postgresql
export PGHOST
</file>


# start postgres 
export PGHOST=/var/run/postgresql
PG=`basename /etc/init.d/postgresql-*`
/sbin/chkconfig $PG on
/sbin/chkconfig --add $PG 

# initdb creates config files, rewrite them restrart service
/sbin/service $PG initdb
/opt/lifemapper/rocks/bin/lmserver_init
/sbin/service $PG start

# init postgrexs db with user info
/opt/lifemapper/rocks/bin/db_init

# create md5 auth client info in config file
/opt/lifemapper/rocks/bin/confPostgres ca

# restart postgres with updated configuration
/sbin/service $PG restart

# start pgbouncer 
BOUNCER=pgbouncer
/sbin/chkconfig $BOUNCER on
/sbin/chkconfig --add $BOUNCER 
/sbin/service $BOUNCER start

# may need this later for postgres tuning 
# rocks set network mtu public 9000
# rocks sync host network `hostname -s`

</post>

</kickstart>
