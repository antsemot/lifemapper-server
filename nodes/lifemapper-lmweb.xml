<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Lifemapper-server roll.
	LMweb install 
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org
	
	</copyright>

	<changelog>
	</changelog>

	<package>lifemapper-mod_wsgi</package>
	<package>opt-lifemapper-cherrypy</package>
	<package>opt-lifemapper-rdflib</package>
	<package>opt-lifemapper-isodate</package>
	<package>opt-lifemapper-processing</package>
	<package>java-1.8.0-openjdk-headless</package>
	<package>java-1.8.0-openjdk</package>
	<package>java-1.8.0-openjdk-devel</package>
	<package>lifemapper-solr</package>

<post>
# check for attribute before setting
attrWebserver=`/opt/rocks/bin/rocks list host attr localhost | /bin/grep LM_webserver | awk '{print $3}'`
if [ "$attrWebserver" = "" ] ; then
    /opt/rocks/bin/rocks add host attr localhost LM_webserver value=true
fi

# mapserver home is for temp files    
/bin/mkdir -p /var/www/tmp
/bin/chown apache:apache /var/www/tmp

# for writing web logs
/usr/sbin/usermod -G lmwriter apache

# FE directory NOT exported to /share, for web logs, uploads, cherrypy sessions
/bin/mkdir -p /state/partition1/lmscratch
/bin/mkdir -p /state/partition1/lmscratch/log
/bin/mkdir -p /state/partition1/lmscratch/log/apache
/bin/mkdir -p /state/partition1/lmscratch/sessions
/bin/mkdir -p /state/partition1/lmscratch/tmpUpload
/bin/chgrp -R lmwriter /state/partition1/lmscratch
/bin/chmod -R g+ws /state/partition1/lmscratch

# add solr user
/usr/sbin/useradd -c "Solr user" solr

# create solr dirs
/bin/mkdir -p           /state/partition1/lmserver/data/solr/data/cores
/bin/mkdir -p           /state/partition1/lmserver/data/solr/data/logs
/bin/chown -R solr:solr /state/partition1/lmserver/data/solr
/bin/chmod -R g+ws      /state/partition1/lmserver/data/solr

# add solr index files
/opt/lifemapper/rocks/bin/solr-index

<file name="/etc/sysconfig/httpd" mode="append" expr="cat /opt/lifemapper/rocks/etc/lifemapper-sysconfig-httpd">

</file>

/sbin/service httpd restart

chkconfig --add solr 
chkconfig  solr on


</post>

</kickstart>
