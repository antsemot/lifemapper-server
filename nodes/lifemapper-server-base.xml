<?xml version="1.0" standalone="no"?>

<kickstart>

	<description>
	Lifemapper-server roll. 
	LMserver and LMweb servers common install 
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org
	</copyright>

	<changelog>
	</changelog>

	<package>flex</package>

        <!-- RPM repos needed for postgresql,postgis,mapserver -->
	<package>pgdg-centos91</package>
	<package>elgis-release</package>

	<!-- lifemapper dependencies -->
	<package>giflib-devel</package>
	<package>byacc</package>
	<package>readline-devel</package>
	<package>pakchois</package>
	<package>neon</package>
	<package>subversion</package>
	<package>hdf4</package>
	<package>hdf4-devel</package>
	<package>hdf5</package>
	<package>hdf5-devel</package>
	<package>cmake</package>
	<package>screen</package>
	<package>lifemapper-proj</package>
	<package>lifemapper-geos</package>
	<package>lifemapper-gdal</package>
	<package>lifemapper-tiff</package>

	<!-- python prerequisites -->
	<package>opt-lifemapper-setuptools</package>
	<package>opt-lifemapper-numexpr</package>
	<package>opt-lifemapper-cython</package>
	<package>opt-lifemapper-pytables</package>
	<package>opt-lifemapper-egenix-mx-base</package>
	<package>opt-lifemapper-psycopg2</package>
	<package>opt-lifemapper-faulthandler</package>

	<!-- lifemapper distro -->
	<package>lifemapper-server</package>
	<package>rocks-lifemapper</package>
	<package>roll-lifemapper-server-usersguide</package>

	<!-- mapserver and prereq -->
	<package>bitstream-vera-fonts-common</package>
	<package>bitstream-vera-sans-fonts</package>
	<package>fribidi</package>
	<package>postgresql91-libs</package>
	<package>mapserver</package>

	<!-- lifemapper data -->
	<package>lifemapper-climate-data</package>
	<package>lifemapper-species-data</package>

<post>

/sbin/ldconfig

GID=`grep lmwriter: /etc/group`
if [ "$GID" == "" ] ; then
    /usr/sbin/groupadd -g 502 lmwriter
fi

</post>

<post>

/bin/mkdir -p /state/partition1/lmserver/log
/bin/mkdir -p /state/partition1/lmserver/data/ClimateData
/bin/mkdir -p /state/partition1/lmserver/data/ESRIDATA
/bin/mkdir -p /state/partition1/lmserver/data/image
/bin/mkdir -p /state/partition1/lmserver/data/models
/bin/mkdir -p /state/partition1/lmserver/data/UserData

/bin/chgrp -R lmwriter /state/partition1/lmserver
/bin/chmod -R g+ws /state/partition1/lmserver/log
/bin/chmod -R g+ws /state/partition1/lmserver/data/models 
/bin/chmod -R g+ws /state/partition1/lmserver/data/UserData

for item in "config" "Lm*" "__init__.py*" ; do
    /bin/chgrp -R lmwriter /opt/lifemapper/$item
    /bin/chmod -R g+ws /opt/lifemapper/$item
done

<file name="/etc/auto.share" mode="append">
lmserver &Kickstart_PrivateHostname;:/export/&amp;
</file>

/etc/init.d/autofs restart

LOG=`ls /share/lmserver | grep log`
if [ "$LOG" != "" ] ; then
    /bin/ln -s /share/lmserver/log /opt/lifemapper/log
else
    /bin/echo "ERROR: directory /share/lmserver/log  does not exist"
fi

</post>

</kickstart>
