#!/bin/bash
#
# This script is creates configuration files for postgres and pgbouncer. 
# The script can be run at any time to remove all the previous configuration
# and create a new one. 

usage () 
{
    echo "Usage: $0"
    echo "This script is run after lifemapper-server installation. It will:"
    echo "     - download and install data named in configuration file"
    echo "   "
    echo "The script can be run at any time to add data and override configuration."
}

if [ $# -ne 0 ]; then
    usage
    exit 0
fi 

set_defaults() {
    LMURL="http://lifemapper.org/dl"
    
    CLIMATE_DIR=@DATADIR_SERVER@/@ENV_DATA_PATH@
    
    CONFIG_FILE=@LMHOME@/config/config.lmserver.ini
    SITE_CONFIG_FILE=@LMHOME@/config/site.ini
    POPULATEPY=@LMHOME@/LmDbServer/tools/initCatalog.py

    LOG=/tmp/`/bin/basename $0`.log
    touch $LOG
}


### Add new scenarios based on metadata in 
### @LMHOME@/LmDbServer/tools/bioclimMeta for SCENARIO_PACKAGE
add_inputs () {
    if [ -f $POPULATEPY ] ; then        
        echo "Add metadata for $SCEN_PKG ..." | tee -a $LOG
        /opt/python/bin/@PYTHONVER@ $POPULATEPY -m all 2>&1 | tee -a $LOG
        
    else
        echo "Error: Missing file $POPULATEPY" | tee -a $LOG
        exit 1
    fi
}

### Retrieve climate data named in SCENARIO_PACKAGE, catalog if successful
get_climate_data () {
    # get the SCENARIO_PACKAGE value from site.ini or config.lmserver.ini file
    SCEN_PKG=`grep SCENARIO_PACKAGE $SITE_CONFIG_FILE | grep -v ';' | awk '{print $2}'`
    if [ ! "$SCEN_PKG" ] ; then 
        SCEN_PKG=`grep SCENARIO_PACKAGE $CONFIG_FILE | grep -v ';' | awk '{print $2}'`
    fi
  
    echo "Looking for climate data $SCEN_PKG"   | tee -a $LOG  
    if [ "$SCEN_PKG" ] ; then
    
        # find metadata files, pkgname.py and pkgname.csv
        filecount=`ls -l @CLIMATE_DIR@/$SCEN_PKG | wc -l`
        if [ "$filecount" > 1 ]; then
            echo "Climate metadata for $SCEN_PKG already present" | tee -a $LOG
            
        else  
            echo "Fetch climate data $SCEN_PKG" | tee -a $LOG
            curl -L "$LMURL/$SCEN_PKG.@TARBALL_POSTFIX@" -o @CLIMATE_DIR@/$SCEN_PKG.@TARBALL_POSTFIX@ 
  
            # uncompress and add to database
            if [ -f @CLIMATE_DIR@/$SCEN_PKG.@TARBALL_POSTFIX@ ] ; then
                tar xzf @CLIMATE_DIR@/$SCEN_PKG.@TARBALL_POSTFIX@ 
            else
                echo "Failed to retrieve $SCEN_PKG ..." | tee -a $LOG
            fi
        fi
    else
        echo "SCENARIO_PACKAGE not set in $SITE_CONFIG_FILE or $CONFIG_FILE" | tee -a $LOG
    fi
}

TimeStamp () {
    echo $1 `/bin/date` >> $LOG
}

####### Main #######
set_defaults
TimeStamp "# Start"

get_climate_data
add_inputs

TimeStamp "# End"
