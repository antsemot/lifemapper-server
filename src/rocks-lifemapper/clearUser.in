#!/bin/bash 

# Purpose: remove User data
#
# This script is run by a superuser

usage () 
{
    echo "Usage: $0 <username>"
    echo "This script is run by the superuser. It will do the following for <username>:"
    echo "     - clear computed user data including OccurrenceLayers from the database"
    echo "     - delete user data including OccurrenceLayers from the filesystem"
    echo "     - delete user makeflow files from the filesystem"
    echo "  It will not"
    echo "     - delete user inputs (scenarios, environmental layers, trees, gridsets, matrices) from the database or filesystem"
    echo "     - delete user configuration files from the filesystem"
    echo "   "
    echo "The output of the script is in @LMSCRATCHDISK@/log/`/bin/basename $0`.log"
}

### define varibles
SetDefaults () {
    THISNAME=`/bin/basename $0`
    # scripts
    CLEANUP_SCRIPT=@LMHOME@/LmDbServer/tools/janitor.py
    USER = $1
    
    LOG=@LMSCRATCHDISK@/log/$THISNAME.log
    rm -f $LOG
    touch $LOG
}

TimeStamp () {
    echo $1 `/bin/date` >> $LOG
}

### delete user computed data from lifemapper DB and filesystem
ClearUser () {
    if [ -f $CLEANUP_SCRIPT ] ; then
        echo "Running '$CLEANUP_SCRIPT'..." | tee -a $LOG
        /opt/python/bin/@PYTHONVER@ $CLEANUP_SCRIPT --user=$USER 2>&1 | tee -a $LOG
    else
        echo "Error: Missing file $CLEANUP_SCRIPT" | tee -a $LOG
        exit 1
    fi
}


### Main ###
if [ $# -ne 0 ]; then
    usage
    exit 0
fi 

SetDefaults
TimeStamp "# Start"
ClearUser
TimeStamp "# End"
