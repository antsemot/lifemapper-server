#!/bin/bash 

# Purpose: populate lifemapper database with GBIF Backbone Taxonomy
#
# This script is run by a superuser

usage () 
{
    echo "Usage: $0"
    echo "This script is run by the superuser. It will "
    echo "     - run readTaxonomy.py to add GBIF Backbone Taxonomy"
    echo "   "
    echo "The output of the script is in @LMSCRATCHDISK@/log/`/bin/basename $0`.log"
}

### define varibles
SetDefaults () {
    # scripts
    TAXONOMYPY=@LMHOME@/LmDbServer/tools/readTaxonomy.py

	 # config files
    CONFIG_FILE=@LMHOME@/config/config.lmserver.ini
    SITE_CONFIG_FILE=@LMHOME@/config/config.site.ini
    
    # get the DATASOURCE  and ARCHIVE_USER values 
    # from config.site.ini or config.lmserver.ini file
    echo "Looking for DATASOURCE in site config file"   | tee -a $LOG  
    DATASOURCE=`grep DATASOURCE $SITE_CONFIG_FILE | grep -v ';' | awk '{print $2}'`

    if [ ! "$DATASOURCE" ] ; then 
        echo "Looking for DATASOURCE in installed config file"   | tee -a $LOG  
        DATASOURCE=`grep DATASOURCE $CONFIG_FILE | grep -v ';' | awk '{print $2}'`
    fi
        
    LOG=@LMSCRATCHDISK@/log/`/bin/basename $0`.log
    rm -f $LOG
    touch $LOG
}

TimeStamp () {
    echo $1 `/bin/date` >> $LOG
}

### read and populate taxonomy table
AddTaxonomy () {
    if [ "$DATASOURCE" == "GBIF" ] || [ "$DATASOURCE" == "IDIGBIO" ] ; then
        echo "Running $TAXONOMYPY ..." | tee -a $LOG
        /opt/python/bin/@PYTHONVER@ $TAXONOMYPY 2>&1 | tee -a $LOG
    else
        echo "Notice: DATASOURCE=$DATASOURCE: No taxonomy to ingest" | tee -a $LOG
        return 
    fi
}

### Main ###
if [ $# -ne 0 ]; then
    usage
    exit 0
fi 

SetDefaults
TimeStamp "# Start"
AddTaxonomy
TimeStamp "# End"
