#!/bin/bash
#
# This script downloads a climate data package, uncompresses it into the 
# correct directory.
# The script can be run at any time to install environmental data for 
# cataloging scenarios and processing an SDM workflow.

usage () 
{
    echo "Usage: $0 <SCENARIO_PACKAGE_NAME>"
    echo "This script is run on an existing lifemapper-server installation. "
    echo "It will:"
    echo "     - download and install SCENARIO_PACKAGE_NAME data in the "
    echo "       common environmental data directory"
    echo "It will NOT:"
    echo "     - install SCENARIO_PACKAGE_NAME scenarios in the database "
    echo "   "
    echo "The script can be run at any time to install environmental data and"
    echo "metadata files."
    echo "   "
}

if [ $# -ne 1 ]; then
    usage
    exit 0
fi 

set_defaults() {
    SCEN_PKG=$1
    LMURL=@LMURL@
    THISNAME=`/bin/basename $0`
    
    CLIMATE_DIR=@DATADIR_SHARED@/@ENV_DATA_DIR@
    
    CONFIG_FILE=@LMHOME@/config/config.lmserver.ini
    SITE_CONFIG_FILE=@LMHOME@/config/config.site.ini

    LOG=@LMSCRATCHDISK@/log/$THISNAME.log
    rm -f $LOG
    touch $LOG

    CLIMATE_META_FILE=$CLIMATE_DIR/$SCEN_PKG.py
    CLIMATE_PKG_FILE=$CLIMATE_DIR/$SCEN_PKG.@TARBALL_POSTFIX@
    NEW_CLIMATE_DATA_DIR=$CLIMATE_DIR/$SCEN_PKG
}


### Retrieve climate data named in SCENARIO_PACKAGE
get_climate_data () {
    # find metadata file pkgname.py
    if [ -f $CLIMATE_META_FILE ]; then
        echo "Climate metadata $CLIMATE_META_FILE already present" | tee -a $LOG
    else  
        echo "Fetch climate data into $CLIMATE_PKG_FILE" | tee -a $LOG
        curl -L "$LMURL/$SCEN_PKG.@TARBALL_POSTFIX@" -o $CLIMATE_PKG_FILE 
  
        # uncompress 
        if [ -f $CLIMATE_PKG_FILE ]; then
            tar xzf $CLIMATE_PKG_FILE -C $CLIMATE_DIR/
            rm -f $CLIMATE_PKG_FILE 
        else
            echo "Failed to retrieve $SCEN_PKG ..." | tee -a $LOG
        fi
    fi
}

fix_permissions () {
    /bin/egrep -i "^lmwriter" /etc/passwd
    if [ $? -ne 0 ]; then
        echo "Error: user lmwriter does not exist" | tee -a $LOG
        exit 1
    fi

    # This script is run by root, so set group write permission on new data dir
    echo "Create and set group write permission on new $NEW_CLIMATE_DATA_DIR data dir"   | tee -a $LOG
    echo "Update lmwriter group permissions on $NEW_CLIMATE_DATA_DIR" | tee -a $LOG
    /bin/chgrp -R lmwriter $NEW_CLIMATE_DATA_DIR
    /bin/chmod -R g+ws $NEW_CLIMATE_DATA_DIR
}


TimeStamp () {
    echo $1 `/bin/date` >> $LOG
}

####### Main #######
set_defaults $1
TimeStamp "# Start"

get_climate_data
fix_permissions

TimeStamp "# End"
