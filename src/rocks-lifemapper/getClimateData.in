#!/bin/bash
#
# This script downloads a climate data package, installs it, and catalogs it 
# in the database for the current default user.
# The script can be run at any time to override the previous configuration
# with a new one. 

usage () 
{
    echo "Usage: $0"
    echo "This script is run after lifemapper-server installation. It will:"
    echo "     - download and install SCENARIO_PACKAGE data named in configuration file"
    echo "     - catalog climate data with the ARCHIVE_USER named in configuration file"
    echo "If the data and/or database records are present, the script will make only needed changes."
    echo "   "
    echo "The script can be run at any time to override configuration with a "
    echo "different user or climate package."
    echo "   "
}

if [ $# -ne 0 ]; then
    usage
    exit 0
fi 

set_defaults() {
    LMURL=@LMURL@
    
    CLIMATE_DIR=@DATADIR_SHARED@/@ENV_DATA_DIR@
    
    CONFIG_FILE=@LMHOME@/config/config.lmserver.ini
    SITE_CONFIG_FILE=@LMHOME@/config/site.ini
    POPULATEPY=@LMHOME@/LmDbServer/tools/initCatalog.py

    LOG=/tmp/`/bin/basename $0`.log
    touch $LOG

    # get the SCENARIO_PACKAGE value from site.ini or config.lmserver.ini file
    echo "Looking for climate data $SCEN_PKG"   | tee -a $LOG  
    SCEN_PKG=`grep SCENARIO_PACKAGE: $SITE_CONFIG_FILE | grep -v ';' | awk '{print $2}'`
    if [ ! "$SCEN_PKG" ] ; then 
        SCEN_PKG=`grep SCENARIO_PACKAGE: $CONFIG_FILE | grep -v ';' | awk '{print $2}'`
    fi
    if [ ! "$SCEN_PKG" ] ; then
        echo "SCENARIO_PACKAGE not set in $SITE_CONFIG_FILE or $CONFIG_FILE" | tee -a $LOG
        exit 1
    fi    

    CLIMATE_META_FILE=$CLIMATE_DIR/$SCEN_PKG.py
    CLIMATE_PKG_FILE=$CLIMATE_DIR/$SCEN_PKG.@TARBALL_POSTFIX@
}


### Retrieve climate data named in SCENARIO_PACKAGE
get_climate_data () {
    # find metadata file pkgname.py
    if [ -f $CLIMATE_META_FILE ]; then
        echo "Climate metadata $CLIMATE_META_FILE already present" | tee -a $LOG
    else  
        echo "Fetch climate data into $CLIMATE_PKG_FILE" | tee -a $LOG
        curl -L "$LMURL/$SCEN_PKG.@TARBALL_POSTFIX@" -o $CLIMATE_PKG_FILE 
  
        # uncompress 
        if [ -f $CLIMATE_PKG_FILE ]; then
            tar xzf $CLIMATE_PKG_FILE -C $CLIMATE_DIR/
            rm -f $CLIMATE_PKG_FILE 
        else
            echo "Failed to retrieve $SCEN_PKG ..." | tee -a $LOG
        fi
    fi
}

TimeStamp () {
    echo $1 `/bin/date` >> $LOG
}

####### Main #######
set_defaults
TimeStamp "# Start"

get_climate_data

TimeStamp "# End"
