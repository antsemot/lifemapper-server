#!/bin/bash
#
# This script downloads a scenario data package, containing a scenario metadata, 
# and raster files. It uncompresses and places data in the correct directory,
# and transforms data into mxe format for Maxent modeling.
#
# The functions in this script are also included in getBoomPackageForUser
#
# The script can be run at any time to download and install environmental data.

usage () 
{
    echo "Usage: $0 <SCEN_PACKAGE_NAME>  <USER_ID>"
    echo "   "
    echo "This script is run on an existing lifemapper-server installation. "
    echo "It will:"
    echo "     - download the BOOM_PACKAGE_NAME data into the "
    echo "       @LMSCRATCHDISK@/temp directory, then install environmental"
    echo "       data into the @DATADIR_SHARED@/@ENV_DATA_DIR@ directory, and"
    echo "       species data into the @DATADIR_SHARED@/archive/<user> directory"
    echo "   "
    echo "The script can be run at any time to download and install data for"
    echo "a BOOM run."
    echo "   "
}

set_defaults() {
    /bin/egrep -i "^lmwriter" /etc/passwd
    if [ $? -ne 0 ]; then
	    echo "Error: user lmwriter does not exist" | tee -a $LOG
        exit 1
    fi

    SCEN_PKG=$1
    USR=$2
    LMURL=@LMURL@
    THISNAME=`/bin/basename $0`
    
	# load opt-python and environment
    source /usr/share/Modules/init/bash
    module load opt-python
    . /etc/profile.d/lifemapper.sh
    TRANSFORMPY=@LMHOME@/LmBackend/tools/convert_layers_in_package.py

    LOG=@LMSCRATCHDISK@/log/$THISNAME.log
    # Append to existing logfile
    touch $LOG
    
    TEMP_DIR=@LMSCRATCHDISK@/temp
    SCEN_DIR=@DATADIR_SHARED@/@ENV_DATA_DIR@

    # *_PKG variables are file basenames, no path or file extension
    echo "Scenario package: $SCEN_PKG, Scenario User: $USR" | tee -a $LOG
    USER_DIR=@DATADIR_SHARED@/archive/$USR
    
    SCEN_META_FILE=$SCEN_DIR/$SCEN_PKG.py
    SCEN_PKG_FILE=$SCEN_PKG.@TARBALL_POSTFIX@

    TMP_SPFILE=$TEMP_DIR/$SCEN_PKG_FILE
}

### Retrieve scenario data named in SCENARIO_PACKAGE into temp dir
pull_scenario_data () {
    # find metadata file pkgname.py
    if [ -f $SCEN_META_FILE ]; then
        echo "Scenario metadata $SCEN_META_FILE already present" | tee -a $LOG
    else  
        echo "Fetch scenario $TMP_SPFILE" | tee -a $LOG
        curl -L "$LMURL/$SCEN_PKG_FILE" -o $TMP_SPFILE
    fi
}

### Create USER directory 
create_user_dir () {
	 # Find or create the test Boom data directory
    if [ -d $USER_DIR ]; then
        echo "USER data directory $USER_DIR already exists" | tee -a $LOG
    else 
        echo "Create data directory $USER_DIR" | tee -a $LOG
        /bin/mkdir $USER_DIR 
	    if [ -d $USER_DIR ]; then
	        /bin/chgrp -R lmwriter $USER_DIR
	        /bin/chmod -R g+ws     $USER_DIR
	    fi
    fi
}

### Retrieve scenario data named in SCENARIO_PACKAGE
move_scenario_data () {
    # find metadata file pkgname.py
    if [ -f $SCEN_META_FILE ]; then
        echo "Scenario metadata $SCEN_META_FILE already present" | tee -a $LOG
    else  
        # uncompress 
        if [ -f $TMP_SPFILE ]; then
		    echo "Uncompress $TMP_SPFILE into $SCEN_DIR"   | tee -a $LOG
            tar xzf $TMP_SPFILE -C $SCEN_DIR/
		    
		    echo "Remove $TMP_SPFILE"   | tee -a $LOG
            rm -f $TMP_SPFILE
            
		    echo "Reset group and write permission on $SCEN_DIR"   | tee -a $LOG
		    /bin/chgrp -R lmwriter $SCEN_DIR
		    /bin/chmod -R g+ws     $SCEN_DIR
        else
            echo "Failed to find $TMP_SPFILE ..." | tee -a $LOG
        fi

    fi
}

set_new_layer_path() {    
    if [ -f $SCEN_META_FILE ]; then
        echo "Looking for new layer dir in scenario metadata file $SCEN_META_FILE"   | tee -a $LOG  
        TOPDIR=`grep -i TOPDIR $SCEN_META_FILE | grep -v ';' | awk '{print $2}'`
    fi
    if [ ! "$TOPDIR" ] ; then
        TOPDIR=$SCEN_PKG
    fi
    
    PUBLIC_LYR_PATH=$SCEN_DIR/$TOPDIR
    USER_LYR_PATH=$USER_DIR/$SCEN_PKG
    
    # Todo: Move to user path instead of public path
    if [ -d $USER_LYR_PATH ]; then
        NEW_LYR_PATH=$USER_LYR_PATH
    else 
        NEW_LYR_PATH=$PUBLIC_LYR_PATH
    fi
    }

### Create ASCII and MXE layers from TIFFs
transform_layers () {
    if [ -d $NEW_LYR_PATH ]; then
        if [ -f $TRANSFORMPY ] ; then
            echo "Convert layers in $NEW_LYR_PATH for $SCEN_PKG to ascii and mxe ..." | tee -a $LOG
            @PYBIN@ $TRANSFORMPY $NEW_LYR_PATH 2>&1 | tee -a $LOG
        else
            echo "Error: Missing file $TRANSFORMPY" | tee -a $LOG
            exit 1
        fi
    else 
        echo "Layer directory $NEW_LYR_PATH does not exist" | tee -a $LOG
    fi

}

instruct_user () {
    echo ""   | tee -a $LOG
    echo "*****************"   | tee -a $LOG
    echo "This script installed data in $SCEN_PKG for any user"   | tee -a $LOG
#     echo "This script installed data in $SCEN_PKG for User $USR"   | tee -a $LOG
    echo "*****************"   | tee -a $LOG
}

TimeStamp () {
    echo $1 `/bin/date` >> $LOG
}

####### Main #######
if [ $# -ne 2 ]; then
    usage
    exit 0
fi 

set_defaults $1 $2
TimeStamp "# Start"

pull_scenario_data
create_user_dir
move_scenario_data
find_new_layer_dir
transform_layers
instruct_user

TimeStamp "# End"
