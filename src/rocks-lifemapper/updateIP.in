#!/bin/bash 
#
# Update @LMHOME@/config/config.ini file with correct ip info  
#


usage () 
{
    echo "Usage: $0"
    echo "This script updates IPs in @LMHOME@/config/config.ini file from"
    echo "the values set in rocks attributes LM_dbserver and LM_webserver."
    echo "If attributes are not set then the server public IP is used"

}

getIP () {
    # public host address
    IP=`/opt/rocks/bin/rocks list host attr localhost | grep Kickstart_PublicAddress | awk '{print $3}'`

    # check for attribute for lifemapper dbserver 
    IPdbserver=`/opt/rocks/bin/rocks list host attr localhost | grep LM_dbserver | awk '{print $3}'`
    if [ "$IPdbserver" = "true" ] || [ "$IPdbserver" = "" ] ; then
        IPdbserver=$IP
    fi

    # check for attribute for lifemapper webserver 
    IPwebserver=`/opt/rocks/bin/rocks list host attr localhost | grep LM_webserver | awk '{print $3}'`
    if [ "$IPwebserver" = "true" ] ||  [ "$IPwebserver" = "" ] ; then
        IPwebserver=$IP
    fi
}

updateIP () {
    infile=@LMHOME@/config/config.ini
    sed -i "s%@PUBLIC_FQDN@%$IP%g" $infile 
    sed -i "s%@WEB_FQDN@%$IPwebserver%g" $infile 
    sed -i "s%@DB_FQDN@%$IPdbserver%g" $infile 
}

#### Main ####

if [ $# -ne 0 ]; then
    usage
    exit 0
fi 

getIP
updateIP
